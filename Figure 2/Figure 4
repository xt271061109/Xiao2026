##Fig. 4a
# Set the identity class to the condition
Idents(combined) <- "condition"

conditions <- c(
  "progenitor1_WT", "progenitor1_KO",
  "progenitor2_WT", "progenitor2_KO",
  "effector_WT",    "effector_KO",
  "proliferating_WT","proliferating_KO",
  "exhausted_WT",   "exhausted_KO"
)

da_list <- setNames(vector("list", length(conditions)), conditions)

for (cond in conditions) {
  message("Running FindMarkers for: ", cond)
  
  res <- FindMarkers(
    object = combined,
    ident.1 = cond,
    ident.2 = NULL,          # vs all other conditions
    only.pos = TRUE,
    test.use = "LR",
    min.pct = 0.05,
    logfc.threshold = 0.25,
    latent.vars = "nCount_ATAC",
    assay = "ATAC"
  )
  
  res$peak <- rownames(res)
  res$condition <- cond
  da_list[[cond]] <- res
}

# Combine all conditions into one dataframe
da_peaks_all_raw <- bind_rows(da_list, .id = NULL)

# View the combined results
head(da_peaks_all_raw)

# Split the 'cluster' column to extract cell type and sample information
# Assuming the 'cluster' column corresponds to 'condition' (e.g., "CellType1_WT")
da_peaks_all_raw <- da_peaks_all_raw %>%
  mutate(celltype = sapply(strsplit(as.character(condition), "_"), `[`, 1),
         # Extract cell type (first part of the condition)
         orig.ident = sapply(strsplit(as.character(condition), "_"), `[`, 2))     # Extract sample (second part of the condition)

# Group by condition (cluster) and select top 50 genes per condition based on avg_log2FC
da_peaks_all_top_50 <- da_peaks_all_raw %>%
  group_by(condition) %>%
  top_n(n = 50, wt = avg_log2FC) %>%
  ungroup()

# Check the number of genes after selecting the top 50 for each condition
cat("Number of genes after selecting top 50 per condition:",
    nrow(da_peaks_all_top_50),
    "\n")

# View top few rows of the all_markers data
head(da_peaks_all_top_50)

# Remove duplicate genes, keeping only the first occurrence
da_peaks_all <-
  da_peaks_all_top_50[!duplicated(da_peaks_all_top_50$peak), ]

# Check the number of rows before and after removing duplicates
cat("Number of genes before removing duplicates:",
    nrow(da_peaks_all_top_50),
    "\n")
cat("Number of genes after removing duplicates:",
    nrow(da_peaks_all),
    "\n")

# Access the links generated by LinkPeaks
DefaultAssay(combined) <- "ATAC"
peak_gene_links <-
  Links(combined)  # This gives you a data frame of peak-gene links
peak_gene_links_df <- as.data.frame(peak_gene_links)

# Rename the "peaks" column to "peak" in da_peaks_all
colnames(da_peaks_all)[colnames(da_peaks_all) == "peaks"] <- "peak"

# Merge DAR results with the linked genes
da_peaks_all_with_genes <-
  merge(da_peaks_all,
        peak_gene_links_df,
        by = "peak",
        all.x = TRUE)

# Add the "label" column based on the "gene" column
da_peaks_all_with_genes$label <-
  ave(
    da_peaks_all_with_genes$gene,
    da_peaks_all_with_genes$gene,
    FUN = function(x) {
      if (length(x) > 1) {
        paste0(x, "_", seq_along(x))
      } else {
        x
      }
    }
  )

# Append the "condition" column to "label" only if "label" is not NA
da_peaks_all_with_genes$label <-
  ifelse(
    !is.na(da_peaks_all_with_genes$label),
    paste(
      da_peaks_all_with_genes$label,
      da_peaks_all_with_genes$condition,
      sep = "_"
    ),
    NA
  )

# Replace NA values in the "label" column with continuous numbers
na_indices <- which(is.na(da_peaks_all_with_genes$label))
da_peaks_all_with_genes$label[na_indices] <-
  as.character(seq_along(na_indices))


rownames(da_peaks_all_with_genes) <- da_peaks_all_with_genes$label

# Group by condition (cluster) and select top 50 genes per condition based on avg_log2FC
da_peaks_all_with_genes_top_50 <- da_peaks_all_with_genes %>%
  group_by(condition) %>%
  top_n(n = 50, wt = avg_log2FC) %>%
  ungroup()

# Check the number of genes after selecting the top 50 for each condition
cat(
  "Number of peaks after selecting top 50 per condition:",
  nrow(da_peaks_all_with_genes_top_50),
  "\n"
)

# View top few rows of the all_markers data
head(da_peaks_all_with_genes_top_50)

# Remove duplicate genes, keeping only the first occurrence
da_peaks_all_with_genes_top <-
  da_peaks_all_with_genes_top_50[!duplicated(da_peaks_all_with_genes_top_50$peak), ]

# Check the number of rows before and after removing duplicates
cat(
  "Number of peaks before removing duplicates:",
  nrow(da_peaks_all_with_genes_top_50),
  "\n"
)
cat("Number of peaks after removing duplicates:",
    nrow(da_peaks_all_with_genes_top),
    "\n")

# Generate a heatmap
Idents(combined) <- combined$celltype

#Using ATAC assay
average_expression_ATAC <-
  AggregateExpression(combined, assays = "ATAC", add.ident = "orig.ident")
average_expression_ATAC_matrix <- average_expression_ATAC$ATAC
average_expression_ATAC_matrix <-
  as.matrix(average_expression_ATAC_matrix)

# Get the peaks from da_peaks_all_with_genes
peaks_to_keep <- da_peaks_all_with_genes_top$peak

# Match the peaks to average_expression_ATAC_matrix and replicate rows
average_expression_matrix_KO_ATAC_all_raw <-
  average_expression_ATAC_matrix[match(peaks_to_keep, rownames(average_expression_ATAC_matrix)),]

# Z-score: (value - mean) / standard deviation
z_score_average_expression_matrix_KO_ATAC_all <- t(scale(t(
  average_expression_matrix_KO_ATAC_all_raw
)))  # Standardize the rows (genes)

# Remove rows with NA/NaN/Inf values
z_score_average_expression_matrix_KO_ATAC_all <-
  z_score_average_expression_matrix_KO_ATAC_all[complete.cases(z_score_average_expression_matrix_KO_ATAC_all), ]

# Manually set the desired column order (e.g., reorder by condition or identity)
desired_column_order <-
  c(
    "progenitor1_WT",
    "progenitor1_KO",
    "progenitor2_WT",
    "progenitor2_KO",
    "effector_WT",
    "effector_KO",
    "proliferating_WT",
    "proliferating_KO",
    "exhausted_WT",
    "exhausted_KO"
  )

# Reorder the columns in the expression matrix
z_score_average_expression_matrix_KO_ATAC_all <-
  z_score_average_expression_matrix_KO_ATAC_all[, desired_column_order]

z_score_average_expression_matrix_KO_ATAC_all <-
  as.data.frame(z_score_average_expression_matrix_KO_ATAC_all)
# Add a new column "label" to z_score_average_expression_matrix_KO_ATAC_all
z_score_average_expression_matrix_KO_ATAC_all$label <-
  da_peaks_all_with_genes_top$label

rownames(z_score_average_expression_matrix_KO_ATAC_all) <-
  z_score_average_expression_matrix_KO_ATAC_all$label

# Remove the "label" column using dplyr
z_score_average_expression_matrix_KO_ATAC_all <-
  z_score_average_expression_matrix_KO_ATAC_all %>%
  dplyr::select(-label)

z_score_average_expression_matrix_KO_ATAC_all <-
  as.matrix(z_score_average_expression_matrix_KO_ATAC_all)

# Transpose the matrix if needed
z_score_transposed_ATAC <-
  t(z_score_average_expression_matrix_KO_ATAC_all)

# Now plot the heatmap with the manually ordered columns
all_peaks_heatmap <- Heatmap(
  z_score_transposed_ATAC,
  name = "Z-score",
  col = colorRamp2(c(
    min(z_score_transposed_ATAC),
    mean(z_score_transposed_ATAC),
    max(z_score_transposed_ATAC)
  ), c("blue", "white", "red")),
  show_row_names = TRUE,
  row_names_gp = gpar(fontsize = 8),
  show_column_names = TRUE,
  cluster_rows = FALSE,
  cluster_columns = TRUE,
  column_names_gp = gpar(fontsize = 10),
  #column_names_rot = 45,  # Rotate column names 45 degrees to the left
  heatmap_legend_param = list(title = "Z-score", legend_height = unit(4, "cm")),
  show_row_dend = FALSE,
  # Remove row dendrogram
  show_column_dend = FALSE,
  # Remove column dendrogram
)

# Set the output to a PDF file with a specified path
pdf(
  "/fs/ess/PAS2205/Tong_xiao/Single-cell_multiome/Figures_code_testing/da_peaks_all_condition_heatmap.pdf",
  width = 16,
  height = 4.5
)  # Replace with your desired path

# Plot the heatmap
draw(all_peaks_heatmap,
     auto_adjust = TRUE,
     heatmap_legend_side = "right")

# Close the PDF device to save the file
dev.off()

#Fig. 4b
combined$condition <-
  factor(
    combined$condition,
    levels = c(
      "progenitor1_WT",
      "progenitor1_KO",
      "progenitor2_WT",
      "progenitor2_KO",
      "effector_WT",
      "effector_KO",
      "proliferating_WT",
      "proliferating_KO",
      "exhausted_WT",
      "exhausted_KO"
    )
  )
Idents(combined) <- combined$condition

# Set the output to a PDF file with a specified path
pdf(
  "/fs/ess/PAS2205/Tong_xiao/Single-cell_multiome/Figures_code_testing/Zeb2_CovergePlot_condition.pdf",
  width = 12,
  height = 9
)  # Replace with your desired path

CoveragePlot(
  combined,
  region = c("chr2-44950000-45200000"),
  features = 'Zeb2',
  assay = 'ATAC',
  expression.assay = 'SCT',
  peaks = FALSE
)

# Close the PDF device to save the file
dev.off()

# Set the output to a PDF file with a specified path
pdf(
  "/fs/ess/PAS2205/Tong_xiao/Single-cell_multiome/Figures_code_testing/S1pr5_CovergePlot_condition.pdf",
  width = 12,
  height = 9
)  # Replace with your desired path

CoveragePlot(
  combined,
  region = c("chr9-21240000-21252000"),
  features = 'S1pr5',
  assay = 'ATAC',
  expression.assay = 'SCT',
  peaks = FALSE
)

# Close the PDF device to save the file
dev.off()

#Fig.4c
library(BiocParallel)
register(SerialParam())
combined <-
  RunChromVAR(object = combined, genome = BSgenome.Mmusculus.UCSC.mm10)

# Use FindAllMarkers to find differential motif activity for all conditions
Idents(combined) <- combined$condition
DefaultAssay(combined) <- "chromvar"
all_differential_motif_activity_raw <- FindAllMarkers(
  combined,
  slot = "data",
  # Use the ChromVAR deviations
  test.use = "wilcox",
  only.pos = TRUE,
  # Only return positive markers
  min.pct = 0.25,
  # Filter features detected in at least 25% of cells
  logfc.threshold = 0.25,
  # Minimum log fold change threshold
  recorrect_umi = FALSE
)

all_differential_motif_activity_raw$TF_name <-
  ConvertMotifID(combined[["ATAC"]], id = all_differential_motif_activity_raw$gene)

# Split the 'cluster' column to extract cell type and sample information
all_differential_motif_activity_raw <-
  all_differential_motif_activity_raw %>%
  mutate(celltype = sapply(strsplit(as.character(cluster), "_"), `[`, 1),
         # Extract cell type (first part of the condition)
         orig.ident = sapply(strsplit(as.character(cluster), "_"), `[`, 2))     # Extract sample (second part of the condition)

# Group by condition (cluster) and select top 50 genes per condition based on avg_log2FC
all_differential_motif_activity_top_50 <-
  all_differential_motif_activity_raw %>%
  group_by(cluster) %>%
  top_n(n = 20, wt = avg_log2FC) %>%
  ungroup()

# Check the number of genes after selecting the top 50 for each condition
cat(
  "Number of genes after selecting top 50 per condition:",
  nrow(all_differential_motif_activity_top_50),
  "\n"
)

# View top few rows of the all_markers data
head(all_differential_motif_activity_top_50)

# Remove duplicate genes, keeping only the first occurrence
all_differential_motif_activity <-
  all_differential_motif_activity_top_50[!duplicated(all_differential_motif_activity_top_50$gene), ]

# Check the number of rows before and after removing duplicates
cat(
  "Number of genes before removing duplicates:",
  nrow(all_differential_motif_activity_top_50),
  "\n"
)
cat(
  "Number of genes after removing duplicates:",
  nrow(all_differential_motif_activity),
  "\n"
)

Idents(combined) <- combined$celltype

#Using chromvar assay
average_expression_chromvar <-
  AggregateExpression(combined,
                      assays = "chromvar",
                      add.ident = "orig.ident",
                      slot = "data")
average_expression_chromvar_matrix <-
  average_expression_chromvar$chromvar
average_expression_chromvar_matrix <-
  as.matrix(average_expression_chromvar_matrix)
average_expression_chromvar_matrix_KO_motif_activity_all <-
  average_expression_chromvar_matrix[rownames(average_expression_chromvar_matrix) %in% all_differential_motif_activity$gene, ]

rownames(average_expression_chromvar_matrix_KO_motif_activity_all) <-
  ConvertMotifID(combined[["ATAC"]],
                 id = rownames(average_expression_chromvar_matrix_KO_motif_activity_all))

# Z-score: (value - mean) / standard deviation
z_score_average_expression_chromvar_matrix_KO_motif_activity_all_raw <-
  t(scale(
    t(average_expression_chromvar_matrix_KO_motif_activity_all)
  ))  # Standardize the rows (genes)

# Remove rows with NA/NaN/Inf values
z_score_average_expression_chromvar_matrix_KO_motif_activity_all <-
  z_score_average_expression_chromvar_matrix_KO_motif_activity_all_raw[complete.cases(z_score_average_expression_chromvar_matrix_KO_motif_activity_all_raw), ]

# Visualize the clustered genes with a heatmap
# Create a row annotation for the clusters
row_anno <- rowAnnotation(Cluster = factor(gene_clusters))

desired_column_order <-
  c(
    "progenitor1_WT",
    "progenitor1_KO",
    "progenitor2_WT",
    "progenitor2_KO",
    "effector_WT",
    "effector_KO",
    "proliferating_WT",
    "proliferating_KO",
    "exhausted_WT",
    "exhausted_KO"
  )

# Reorder the columns in the expression matrix
z_score_average_expression_chromvar_matrix_KO_motif_activity_all <-
  z_score_average_expression_chromvar_matrix_KO_motif_activity_all[, desired_column_order]

# Transpose the matrix if needed
z_score_transposed_motif_activity <-
  t(z_score_average_expression_chromvar_matrix_KO_motif_activity_all)


all_motif_activity_heatmap <- Heatmap(
  z_score_transposed_motif_activity,
  name = "Z-score",
  col = colorRamp2(c(
    min(z_score_transposed_motif_activity),
    mean(z_score_transposed_motif_activity),
    max(z_score_transposed_motif_activity)
  ), viridis(3)),
  show_row_names = TRUE,
  row_names_gp = gpar(fontsize = 8),
  show_column_names = TRUE,
  cluster_rows = FALSE,
  cluster_columns = TRUE,
  column_names_gp = gpar(fontsize = 10),
  column_names_rot = 45,
  # Rotate column names 45 degrees to the left
  heatmap_legend_param = list(title = "Z-score", legend_height = unit(4, "cm")),
  show_row_dend = FALSE,
  # Remove row dendrogram
  show_column_dend = FALSE,
  # Remove column dendrogram
)

# Set the output to a PDF file with a specified path
pdf(
  "/fs/ess/PAS2205/Tong_xiao/Single-cell_multiome/Figures_code_testing/all_motif_condition_heatmap.pdf",
  width = 14,
  height = 4
)  # Replace with your desired path

# Plot the heatmap
draw(
  all_motif_activity_heatmap,
  auto_adjust = TRUE,
  heatmap_legend_side = "right"
)

# Close the PDF device to save the file
dev.off()

#Fig.4d
#find d_motifs for the progenitor2 subset comparing control vs ZFP148 KO
Idents(combined) <- combined$celltype
combined_subset <-
  subset(x = combined, idents = "progenitor1")
combined_subset <-
  subset(x = combined, idents = "progenitor2")
combined_subset <- subset(x = combined, idents = "exhausted")
combined_subset <- subset(x = combined, idents = "effector")
combined_subset <- subset(x = combined, idents = "proliferating")

# find markers for subset
DefaultAssay(combined_subset) <- "chromvar"
Idents(combined_subset) <- combined_subset$orig.ident
KO_motif_activity_subset <- FindMarkers(
  combined_subset,
  ident.1 = "KO",
  ident.2 = "WT",
  slot = "data",
  # Use the ChromVAR deviations
  test.use = "wilcox",
  min.pct = 0.25,
  logfc.threshold = 0.25,
  # Minimum percentage of cells expressing the motif
  assay = "chromvar"
)

# Add a column named "gene" using the row names
KO_motif_activity_subset$motif <- rownames(KO_motif_activity_subset)

# Convert motif IDs to TF names
KO_motif_activity_subset$TF_name <-
  ConvertMotifID(combined[["ATAC"]], id = KO_motif_activity_subset$motif)

# Check the first few rows to confirm the change
head(KO_motif_activity_subset, n = 50)

# generate volcano plot for d_motif_activity_subset
data <- KO_motif_activity_subset

# Set the threshold for significance
logFC_threshold <- 0.5  # Fold change threshold
p_val_threshold <- 0.05  # p-value threshold

#Plot using EnhancedVolcano package
keyvals <- ifelse(
  data$avg_log2FC < -0.5 & data$p_val_adj <= 0.05,
  '#8DCDD5',
  ifelse(
    data$avg_log2FC > 0.5 &
      data$p_val_adj <= 0.05,
    '#E6846D',
    '#A9A9A9'
  )
)
keyvals[is.na(keyvals)] <- '#A9A9A9'
names(keyvals)[keyvals == '#E6846D'] <- 'high'
names(keyvals)[keyvals == '#A9A9A9'] <- 'mid'
names(keyvals)[keyvals == '#8DCDD5'] <- 'low'

# Select top 15 upregulated and top 15 downregulated genes
top_up_motif <- data %>%
  dplyr::filter(p_val_adj < 0.05) %>%
  arrange(desc(avg_log2FC)) %>%
  head(15) %>%
  pull(TF_name)

top_down_motif <- data %>%
  dplyr::filter(p_val_adj < 0.05) %>%
  arrange(avg_log2FC) %>%
  head(15) %>%
  pull(TF_name)

# Combine selected gene names
selected_motifs <- c(top_up_motif, top_down_motif)

# Ensure p-values are not zero by replacing them with a small value
min_nonzero <-
  min(data$p_val_adj[data$p_val_adj > 0], na.rm = TRUE)  # Find smallest nonzero p-value
data$p_val_adj[data$p_val_adj == 0] <-
  min_nonzero * 0.1  # Replace 0 with 10% of the smallest nonzero p-value

# EnhancedVolcano plot with only top 10 up/down genes labeled
volcano_plot <- EnhancedVolcano(
  data,
  lab = data$TF_name,
  x = 'avg_log2FC',
  y = 'p_val_adj',
  xlab = 'Log2 Fold Change',
  ylab = '-Log10 Adjusted p-value',
  pCutoff = p_val_threshold,
  FCcutoff = logFC_threshold,
  pointSize = 2,
  labSize = 3,
  colAlpha = 0.8,
  colCustom = keyvals,
  legendPosition = 'right',
  xlim = c(-6, 6),
  arrowheads = FALSE,
  drawConnectors = TRUE,
  widthConnectors = 0.5,
  lengthConnectors = 5,
  typeConnectors = "closed",
  max.overlaps = 20
)

# Set the output to a PDF file with a specified path
pdf(
  "/fs/ess/PAS2205/Tong_xiao/Single-cell_multiome/Figures_code_testing/Volcano_d_motif_progenitor2.pdf",
  width = 7,
  height = 6
)  # Replace with your desired path

# Display the plot
print(volcano_plot)

# Close the PDF device to save the file
dev.off()

#find d_motifs for the effector subset comparing control vs ZFP148 KO
Idents(combined) <- combined$celltype
combined_subset <- subset(x = combined, idents = "effector")

## find markers for subset
DefaultAssay(combined_subset) <- "chromvar"
Idents(combined_subset) <- combined_subset$orig.ident
KO_motif_activity_subset <- FindMarkers(
  combined_subset,
  ident.1 = "KO",
  ident.2 = "WT",
  slot = "data",
  # Use the ChromVAR deviations
  test.use = "wilcox",
  min.pct = 0.25,
  logfc.threshold = 0.25,
  # Minimum percentage of cells expressing the motif
  assay = "chromvar"
)

# Add a column named "gene" using the row names
KO_motif_activity_subset$motif <- rownames(KO_motif_activity_subset)

# Convert motif IDs to TF names
KO_motif_activity_subset$TF_name <-
  ConvertMotifID(combined[["ATAC"]], id = KO_motif_activity_subset$motif)

# Check the first few rows to confirm the change
head(KO_motif_activity_subset, n = 50)

# generate volcano plot for d_motif_activity_subset
data <- KO_motif_activity_subset

## Set the threshold for significance
logFC_threshold <- 0.5  # Fold change threshold
p_val_threshold <- 0.05  # p-value threshold

#Plot using EnhancedVolcano package
keyvals <- ifelse(
  data$avg_log2FC < -0.5 & data$p_val_adj <= 0.05,
  '#8DCDD5',
  ifelse(
    data$avg_log2FC > 0.5 &
      data$p_val_adj <= 0.05,
    '#E6846D',
    '#A9A9A9'
  )
)
keyvals[is.na(keyvals)] <- '#A9A9A9'
names(keyvals)[keyvals == '#E6846D'] <- 'high'
names(keyvals)[keyvals == '#A9A9A9'] <- 'mid'
names(keyvals)[keyvals == '#8DCDD5'] <- 'low'

# Select top 15 upregulated and top 15 downregulated genes
top_up_motif <- data %>%
  dplyr::filter(p_val_adj < 0.05) %>%
  arrange(desc(avg_log2FC)) %>%
  head(15) %>%
  pull(TF_name)

top_down_motif <- data %>%
  dplyr::filter(p_val_adj < 0.05) %>%
  arrange(avg_log2FC) %>%
  head(15) %>%
  pull(TF_name)

# Combine selected gene names
selected_motifs <- c(top_up_motif, top_down_motif)

# Ensure p-values are not zero by replacing them with a small value
min_nonzero <-
  min(data$p_val_adj[data$p_val_adj > 0], na.rm = TRUE)  # Find smallest nonzero p-value
data$p_val_adj[data$p_val_adj == 0] <-
  min_nonzero * 0.1  # Replace 0 with 10% of the smallest nonzero p-value

# EnhancedVolcano plot with only top 15 up/down genes labeled
volcano_plot <- EnhancedVolcano(
  data,
  lab = data$TF_name,
  x = 'avg_log2FC',
  y = 'p_val_adj',
  xlab = 'Log2 Fold Change',
  ylab = '-Log10 Adjusted p-value',
  pCutoff = p_val_threshold,
  FCcutoff = logFC_threshold,
  pointSize = 2,
  labSize = 3,
  colAlpha = 0.8,
  colCustom = keyvals,
  legendPosition = 'right',
  arrowheads = FALSE,
  drawConnectors = TRUE,
  widthConnectors = 0.5,
  lengthConnectors = 5,
  typeConnectors = "closed",
  max.overlaps = 20
)

# Set the output to a PDF file with a specified path
pdf(
  "/fs/ess/PAS2205/Tong_xiao/Single-cell_multiome/Figures_code_testing/Volcano_d_motif_effector.pdf",
  width = 7,
  height = 6
)  # Replace with your desired path

# Display the plot
print(volcano_plot)

# Close the SVG device to save the file
dev.off()

#Fig.4e
#Plot violin plots for a list of TF motifs
# List of TF motifs you want to plot
motif_list <- c("MA0769.2", "MA0690.1", "MA1525.1")

# Directory to save plots
output_dir <-
  "/fs/ess/PAS2205/Tong_xiao/Single-cell_multiome/Figures_code_testing"
dir.create(output_dir, showWarnings = FALSE) # Change it to your own directory

# Set the desired order for the 'celltype' levels
combined$celltype <-
  factor(
    combined$celltype,
    levels = c(
      "progenitor1",
      "progenitor2",
      "effector",
      "proliferating",
      "exhausted"
    )
  )

# Loop through each gene and save the plot
for (motif in motif_list) {
  p <- VlnPlot(
    object = combined,
    features = motif,
    group.by = 'celltype',
    split.by = 'orig.ident',
    assay = "chromvar",
    pt.size = 0
  )
  
  # Save plot
  ggsave(
    filename = file.path(output_dir, paste0(motif, "_vlnplot.pdf")),
    plot = p,
    width = 8,
    height = 6
  )
}
